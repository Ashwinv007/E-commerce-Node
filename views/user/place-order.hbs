<div class="place-order-page">
    <form id="checkout-form">
        <div class="order-page-container">
            <!-- Left Section - Shipping Details -->
            <div class="shipping-details-section">
                <h2 class="section-heading">Shipping Details</h2>
                
                <div class="shipping-form-group">
                    <label for="address">Address:</label>
                    <input type="text" id="address" name="address" placeholder="Enter your address" value="{{address}}" required>
                </div>

                <div class="shipping-form-group">
                    <label for="pincode">Pincode:</label>
                    <input type="text" id="pincode" name="pincode" placeholder="Enter your pincode" value="{{pincode}}" required>
                </div>

                <div class="shipping-form-group">
                    <label for="mobile">Mobile:</label>
                    <input type="tel" id="mobile" name="mobile" placeholder="Enter your mobile number" value="{{mobile}}" required>
                    <input type="text" name="userId" id="" value="{{user._id}}" hidden>
                </div>

                <div class="coupon-section" id="coupon-section">
                    <div class="shipping-form-group">
                        <label for="couponCode">Coupon Code:</label>
                        <div class="coupon-input-wrapper">
                            <input type="text" id="coupon" name="coupon" placeholder="Enter coupon code">
                            <button type="button" class="redeem-coupon-btn" onclick="checkCoupon('{{user._id}}')">
                                Redeem Coupon
                            </button>
                        </div>
                    </div>
                    <div id="coupon-message-area"></div>
                </div>
            </div>

            <!-- Right Section - Order Summary & Payment -->
            <div class="order-summary-sidebar">
                <!-- Order Summary -->
                <div class="summary-card">
                    <h3 class="summary-heading">Order Summary</h3>
                    <div class="summary-amount-row">
                        <span class="summary-label">Total Amount</span>
                        {{#if totalAmount}}
                        <span class="summary-value">Rs:{{totalAmount}}/-</span>
                        {{else}}
                        <span class="summary-value">Rs:{{total}}/-</span>
                        {{/if}}
                    </div>
                     <input id="reOrder" style="display:none" name="reOrder" value='{{reOrder}}'>
                </div>

                <!-- Payment Method -->
                <div class="payment-method-card">
                    <h3 class="summary-heading">Payment Method</h3>
                    <div class="payment-options">
                        <div class="payment-option">
                            <input type="radio" id="cod" name="payment-method" value="COD" checked>
                            <label for="cod">Cash on Delivery (COD)</label>
                        </div>
                        <div class="payment-option">
                            <input type="radio" id="onlinePayment" name="payment-method" value="OnlinePayment">
                            <label for="online">Online Payment</label>
                        </div>
                    </div>

                    <button type="submit" class="checkout-action-btn">
                        Checkout
                    </button>
                </div>
            </div>
        </div>
    </form>
</div>

<script>
    let initialTotal = parseFloat($('.summary-value').text().replace('Rs:', '').replace('/-', ''));

    $('#checkout-form').submit((e)=>{
        e.preventDefault()
        $.ajax({
            url:'/place-order',
            method:'post',
            data:$('#checkout-form').serialize(),
            success:(response)=>{

                if(response.codSuccess){
                    location.href='/order-success'
                }else{
                    razorpayPayment(response)
                }
            }
        })
    })
    function razorpayPayment(order){
var options = {
    "key": "rzp_test_KuRfDd0Fixd4Cj", // Enter the Key ID generated from the Dashboard
    "amount": order.amount, // Amount is in currency subunits. Default currency is INR. Hence, 50000 refers to 50000 paise
    "currency": "INR",
    "name": "Waregram", //your business name
    "description": "Test Transaction",
    "image": "https://example.com/your_logo",
    "order_id": order.id, //This is a sample Order ID. Pass the `id` obtained in the response of Step 1
    "handler": function (response){
        

        verifyPayment(response,order)
    },
    "prefill": { //We recommend using the prefill parameter to auto-fill customer's contact information, especially their phone number
        "name": "Gaurav Kumar", //your customer's name
        "email": "gaurav.kumar@example.com", 
        "contact": "9000090000"  //Provide the customer's phone number for better conversion rates 
    },
    "notes": {
        "address": "Razorpay Corporate Office"
    },
    "theme": {
        "color": "#3399cc"
    }
};
var rzp1 = new Razorpay(options);

    rzp1.open();

    
}

  function checkCoupon(userId){
        let couponCode = document.getElementById('coupon').value;
        let couponMessageArea = document.getElementById('coupon-message-area');
        couponMessageArea.innerHTML = ''; // Clear previous messages

        // Disable coupon input and redeem button to prevent multiple submissions
        document.getElementById('coupon').disabled = true;
        document.querySelector('.redeem-coupon-btn').disabled = true;

        $.ajax({
            url:'/verify-coupon',
            method:'post',
            data:{
                coupon:couponCode,
                userId: userId // Pass userId to the server
            },
            success:(response)=>{
                console.log(response)
                if(typeof(response.response)==='number'){
                    // Coupon applied successfully
                    let newTotal = response.response;
                    let discountAmount = initialTotal - newTotal;
                    $('.summary-value').text('Rs:' + newTotal.toFixed(2) + '/-');


                    let discountElement = document.createElement("input");
                    discountElement.type = "hidden"; // Hidden input for discount value
                    discountElement.name = "discount";
                    discountElement.value = discountAmount;
                    couponMessageArea.appendChild(discountElement);

                    let successMessage = document.createElement("span");
                    successMessage.innerHTML = `Coupon Applied! Discount: Rs. ${discountAmount.toFixed(2)}/-`;
                    successMessage.style.color = "green";
                    couponMessageArea.appendChild(successMessage);

                    let removeButton = document.createElement("button");
                    removeButton.innerHTML = '<i class="fas fa-times"></i> Remove';
                    removeButton.classList.add('btn', 'btn-danger', 'btn-sm', 'ml-2');
                    removeButton.onclick = function() { removeCoupon(userId); };
                    couponMessageArea.appendChild(removeButton);

                }else{
                    // Coupon verification failed
                    let errorMessage = document.createElement("span");
                    errorMessage.innerHTML = response.response;
                    errorMessage.style.color = "red";
                    couponMessageArea.appendChild(errorMessage);

                    // Re-enable input and button for error cases
                    document.getElementById('coupon').disabled = false;
                    document.querySelector('.redeem-coupon-btn').disabled = false;
                }
            },
            error: (jqXHR, textStatus, errorThrown) => {
                let errorMessage = document.createElement("span");
                errorMessage.innerHTML = "Error verifying coupon. Please try again.";
                errorMessage.style.color = "red";
                couponMessageArea.appendChild(errorMessage);

                document.getElementById('coupon').disabled = false;
                document.querySelector('.redeem-coupon-btn').disabled = false;
            }
        })
    }

    function removeCoupon(userId){
        // Clear message area
        document.getElementById('coupon-message-area').innerHTML = '';
        $('.summary-value').text('Rs:' + initialTotal.toFixed(2) + '/-');

        // Re-enable coupon input and redeem button
        document.getElementById('coupon').disabled = false;
        document.getElementById('coupon').value = ''; // Clear coupon input
        document.querySelector('.redeem-coupon-btn').disabled = false;
    }
       

    function verifyPayment(payment,order){
        $.ajax({
            url:'/verify-payment',
            data:{
                payment,
                order
            },
            method:'post',
            success:(response)=>{
                console.log(response.status)
                if(response.status){
                    location.href='/order-success'
                }else{
                    alert('Payment failed')
                }
            }
        })
    

    }
</script>