<div class="container">
    {{#if product}}
    <div class="product-section">
        <div class="product-image-section">
            <div class="image-container">
                {{#if product.imageUrls.[0]}}
                    <img id="mainImage" src="{{product.imageUrls.[0]}}" alt="{{product.productName}}">
                    {{#if product.imageUrls.[1]}}
                    <button class="nav-button prev" onclick="changeImage(-1)">â€¹</button>
                    <button class="nav-button next" onclick="changeImage(1)">â€º</button>
                    {{/if}}
                {{else}}
                    <img id="mainImage" src="https://source.unsplash.com/random/400x400/?product" alt="No image available">
                {{/if}}
            </div>
        </div>

        <div class="product-details">
            <h1 class="product-title">{{product.productName}}</h1>
            
            <div class="rating-section">
                {{#if response.average}}
                <span class="stars" data-rating="{{response.average}}"></span>
                <span class="rating-text">{{response.average}} ({{response.totalReviews}} reviews)</span>
                {{else}}
                <span class="rating-text">No reviews yet.</span>
                {{/if}}
            </div>

            <div class="price-section">
                <span class="current-price">â‚¹{{product.productPrice}}</span>
            </div>

            <h2 class="section-title">Description</h2>
            <p class="description">
                {{product.productDescription}}
            </p>

            <div class="quantity-section">
                <span class="quantity-label">Quantity:</span>
                <div class="quantity-controls">
                    <button class="quantity-btn" onclick="updateQuantity(-1)">-</button>
                    <input type="text" class="quantity-input" value="1" id="quantityInput" readonly>
                    <button class="quantity-btn" onclick="updateQuantity(1)">+</button>
                </div>
            </div>

            <div class="action-buttons">
                <button id="cartButton" class="add-to-cart-btn" onclick="addToCart(event, '{{product._id}}')">
                    <span>ðŸ›’</span>
                    Add to Cart
                </button>
                <button class="icon-btn">â™¡</button>
                <button class="icon-btn">â¤´</button>
            </div>
             <div id="stockAvailability" name="stockAvailability" >
        <input type="number" id="stockAmount" name="stockAmount" style="display:none" value="{{product.stockAmount}}">
        <h2 id="runningOutOfStock" style="display: none; color:red">Running out of Stock!</h2>
        <h2 id="outOfStock" style="display:none; color:red">Out of Stock</h2>
         </div>

            <div class="shipping-info">
                <span class="info-label">Free Shipping</span>
                <span class="info-value">On orders over â‚¹500</span>
                
                <span class="info-label">Delivery</span>
                <span class="info-value">3-5 business days</span>
                
                <span class="info-label">Returns</span>
                <span class="info-value">30-day return policy</span>
            </div>
        </div>
    </div>
    {{/if}}

    <div class="reviews-section">
        <h2 class="reviews-title">Customer Reviews</h2>

        {{#if response.totalReviews}}
        <div class="reviews-summary">
            <span class="summary-label">Average Rating</span>
            <span class="summary-value">
                 <span class="stars" data-rating="{{response.average}}"></span>
            </span>
            
            <span class="summary-label">Total Reviews</span>
            <span class="summary-value">{{response.totalReviews}}</span>
        </div>
        {{/if}}

        {{#if hasOrdered}}
            {{#if userReview}}
                <h3 class="review-title">Your Review</h3>
                <div class="review-item">
                    <div class="review-header">
                        <div class="review-stars" data-rating="{{userReview.ratingValue}}">
                        </div>
                        <span class="review-date">{{formatDate userReview.date}}</span>
                    </div>
                    <h4 class="review-title-text">{{userReview.user.name}}</h4>
                    <p class="review-text">
                        {{userReview.userReview}}
                    </p>
                </div>
            {{else}}
                <div class="write-review">
                    <h3 class="review-title">Write a Review</h3>
                    <form action="/submit-review" method="post" id="reviewForm">
                        <div class="rating-input">
                            <label class="rating-label">Rating:</label>
                            <div class="star-rating">
                                <span data-value="1">â˜†</span><span data-value="2">â˜†</span><span data-value="3">â˜†</span><span data-value="4">â˜†</span><span data-value="5">â˜†</span>
                            </div>
                            <input type="hidden" name="ratingValue" id="ratingValue" value="0">
                            <input type="hidden" name="productId" value="{{product._id}}">
                            <input type="hidden" name="userId" value="{{user._id}}">
                        </div>

                        <textarea name="userReview" class="review-input review-textarea" placeholder="Comment"></textarea>
                        
                        <button type="submit" class="submit-review-btn">Submit Review</button>
                    </form>
                </div>
            {{/if}}
        {{/if}}

        {{#each reviews}}
        <div class="review-item">
            <div class="review-header">
                 <div class="review-stars" data-rating="{{this.ratingValue}}">
                </div>
                <span class="review-date">{{formatDate this.date}}</span>
            </div>
            <h4 class="review-title-text">{{this.user.name}}</h4>
            <p class="review-text">
                {{this.userReview}}
            </p>
        </div>
        {{/each}}
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Image Slider
        const images = [
            {{#each product.imageUrls}}
            "{{this}}",
            {{/each}}
        ];
        let currentImageIndex = 0;
        const mainImage = document.getElementById('mainImage');

        window.changeImage = function(direction) {
            currentImageIndex += direction;
            if (currentImageIndex < 0) {
                currentImageIndex = images.length - 1;
            } else if (currentImageIndex >= images.length) {
                currentImageIndex = 0;
            }
            if (mainImage) {
                mainImage.src = images[currentImageIndex];
            }
        }

        // Quantity Controls
        const quantityInput = document.getElementById('quantityInput');
        window.updateQuantity = function(change) {
            if (quantityInput) {
                let quantity = parseInt(quantityInput.value, 10);
                quantity += change;
                if (quantity < 1) {
                    quantity = 1;
                }
                quantityInput.value = quantity;
            }
        }

        // Star Rating Input
        const starRatingContainer = document.querySelector('.star-rating');
        if (starRatingContainer) {
            const stars = starRatingContainer.querySelectorAll('span');
            const ratingValueInput = document.getElementById('ratingValue');

            stars.forEach(star => {
                star.addEventListener('click', () => {
                    const rating = parseInt(star.dataset.value, 10);
                    ratingValueInput.value = rating;
                    stars.forEach((s, i) => {
                        s.innerHTML = i < rating ? 'â˜…' : 'â˜†';
                        if (i < rating) {
                            s.classList.add('active');
                        } else {
                            s.classList.remove('active');
                        }
                    });
                });
            });
        }

        function displayStars(container) {
            const rating = parseFloat(container.dataset.rating);
            const fullStars = Math.floor(rating);
            const halfStar = rating % 1 >= 0.5;
            let starHTML = '';
            for (let i = 0; i < 5; i++) {
                if (i < fullStars) {
                    starHTML += '<span>â˜…</span>';
                } else if (i === fullStars && halfStar) {
                    starHTML += '<span>â˜…</span>'; // Or use a half-star icon if available
                } else {
                    starHTML += '<span>â˜†</span>';
                }
            }
            container.innerHTML = starHTML;
        }

        // Display existing ratings as stars
        document.querySelectorAll('.stars[data-rating]').forEach(displayStars);
        document.querySelectorAll('.review-stars[data-rating]').forEach(displayStars);

        // Stock Check
        function checkStock() {
            let stockAmountElement = document.getElementById("stockAmount");
            if (stockAmountElement) {
                let stockAmount = parseInt(stockAmountElement.value, 10);
                if (stockAmount <= 10 && stockAmount > 0) {
                    document.getElementById("runningOutOfStock").style.display = "block";
                } else if (stockAmount === 0) {
                    document.getElementById("outOfStock").style.display = "block";
                    const cartButton = document.getElementById("cartButton");
                    if (cartButton) {
                        cartButton.disabled = true;
                    }
                }
            }
        }
        checkStock();
    });
</script>